name: CodeQL Crypto Inventory

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  analyze:
    name: CodeQL (Java) + CSV inventory
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Initialize CodeQL (creates the DB during Analyze)
      - name: Initialize CodeQL
        id: init-codeql
        uses: github/codeql-action/init@v3
        with:
          languages: java

      # Compile the tiny demo so extraction succeeds
      - name: Build demo manually
        run: |
          mkdir -p build
          javac -d build demo/src/Demo.java

      # Optional: run default suite so you also get SARIF in Security tab
      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # --- CUSTOM INVENTORY: build & run our query pack ---

      # Install deps and build the query pack so imports resolve
      - name: Install & build query pack
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"
          # Clean any stale lock
          rm -f queries/codeql-pack.lock.yml || true
          # Install dependencies declared in qlpack.yml (codeql/java-all)
          "$CODEQL" pack install ./queries --no-strict-mode
          # Build the pack (creates ./queries/dist/*.tgz and fully resolves imports)
          "$CODEQL" pack build ./queries

      # Run our query against the DB and export CSV
      - name: Export CSV inventory
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"

          # Locate the DB produced by the CodeQL action
          DB_DIR="$(find "$RUNNER_TEMP/codeql_databases" -type f -name codeql-database.yml -print -quit | xargs dirname || true)"
          if [ -z "${DB_DIR:-}" ]; then
            echo "Could not locate CodeQL Java database"; ls -R "$RUNNER_TEMP" || true; exit 1
          fi
          echo "Using DB at: $DB_DIR"

          # Use the pack's lockfile + dist to resolve imports reliably
          SEARCH_PATH="./queries:$(dirname "$CODEQL")/../qlpacks"
          echo "Search path: $SEARCH_PATH"

          "$CODEQL" query run queries/crypto-inventory.ql \
            --database "$DB_DIR" \
            --search-path "$SEARCH_PATH" \
            --additional-packs ./queries \
            --output results.bqrs

          "$CODEQL" bqrs decode results.bqrs --format=csv > inventory.csv

          # Optional quick weak-crypto matches
          egrep -i 'MD5|SHA-1|SHA1withRSA|DES|3DES|RC4|AES/ECB|TLSv1(?!\.)|SHA1PRNG|RSA.*,Arg0,1[0-9]{3}' inventory.csv || true > legacy_flags.txt

      - name: Upload inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-inventory
          path: |
            inventory.csv
            legacy_flags.txt
