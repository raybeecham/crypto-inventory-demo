name: CodeQL Crypto Inventory

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  analyze:
    name: CodeQL (Java) + CSV inventory
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Initialize CodeQL
        id: init-codeql
        uses: github/codeql-action/init@v3
        with:
          languages: java 

      # We just compile the tiny demo so the extractor can run
      - name: Build demo manually
        run: |
          mkdir -p build
          javac -d build demo/src/Demo.java

      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      - name: Export CSV inventory
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"

          # Find the database directory created by the actions
          DB_DIR="$(find "$RUNNER_TEMP/codeql_databases" -type f -name codeql-database.yml -print -quit | xargs dirname || true)"
          if [ -z "${DB_DIR:-}" ]; then
            echo "Could not locate CodeQL Java database"; ls -R "$RUNNER_TEMP" || true; exit 1
          fi
          echo "Using DB at: $DB_DIR"

          # Run our query as a pack so 'import java' resolves
          "$CODEQL" query run queries/crypto-inventory.ql \
            --database "$DB_DIR" \
            --additional-packs ./queries \
            --output results.bqrs

          "$CODEQL" bqrs decode results.bqrs --format=csv > inventory.csv

          # Quick weak-crypto filter (optional)
          egrep -i 'MD5|SHA-1|SHA1withRSA|DES|3DES|RC4|AES/ECB|TLSv1(?!\.)|SHA1PRNG|RSA.*,Arg0,1[0-9]{3}' inventory.csv || true > legacy_flags.txt

      - name: Upload inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-inventory
          path: |
            inventory.csv
            legacy_flags.txt
