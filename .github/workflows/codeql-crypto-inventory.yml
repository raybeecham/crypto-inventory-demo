name: CodeQL Crypto Inventory

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  analyze:
    name: CodeQL (Java) + CSV inventory
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Initialize CodeQL
        id: init-codeql
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Build demo manually
        run: |
          mkdir -p build
          javac -d build demo/src/Demo.java

      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      - name: Install query pack deps
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"
          # clean any stale lock
          rm -f queries/codeql-pack.lock.yml || true
          # install deps (codeql/java-all) into ~/.codeql/packages
          "$CODEQL" pack install ./queries --no-strict-mode

      - name: Export CSV inventory
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"

          # Locate the DB created by the action
          DB_DIR="$(find "$RUNNER_TEMP/codeql_databases" -type f -name codeql-database.yml -print -quit | xargs dirname || true)"
          if [ -z "${DB_DIR:-}" ]; then
            echo "Could not locate CodeQL Java database"; ls -R "$RUNNER_TEMP" || true; exit 1
          fi
          echo "Using DB at: $DB_DIR"

          # Build a robust search path:
          #  1) CLI's built-in qlpacks, 2) user cache where pack install puts deps, 3) our local queries pack
          QLPACKS_DIR="$(dirname "$CODEQL")/../qlpacks"
          USER_PACKS="$HOME/.codeql/packages"
          SEARCH_PATH="$QLPACKS_DIR:$USER_PACKS:./queries"
          echo "Search path: $SEARCH_PATH"

          # Run the custom query (loose .ql) with explicit search path
          "$CODEQL" query run queries/crypto-inventory.ql \
            --database "$DB_DIR" \
            --search-path "$SEARCH_PATH" \
            --additional-packs ./queries \
            --output results.bqrs

          "$CODEQL" bqrs decode results.bqrs --format=csv > inventory.csv
          egrep -i 'MD5|SHA-1|SHA1withRSA|DES|3DES|RC4|AES/ECB|TLSv1(?!\.)|SHA1PRNG|RSA.*,Arg0,1[0-9]{3}' inventory.csv || true > legacy_flags.txt

      - name: Upload inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-inventory
          path: |
            inventory.csv
            legacy_flags.txt
