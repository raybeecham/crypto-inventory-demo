name: CodeQL Crypto Inventory

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  analyze:
    name: CodeQL (Java) + CSV inventory
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Initialize CodeQL (Java)
      - name: Initialize CodeQL
        id: init-codeql
        uses: github/codeql-action/init@v3
        with:
          languages: java

      # Tiny manual build so the extractor runs (works for the demo file)
      - name: Build demo manually
        run: |
          mkdir -p build
          javac -d build demo/src/Demo.java

      # Run default CodeQL analysis (optional, for SARIF in Security tab)
      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # Ensure our query pack deps are installed (codeql/java-all)
      - name: Install query pack deps
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"
          rm -f queries/codeql-pack.lock.yml
          "$CODEQL" pack install ./queries --no-strict-mode

      # Run the custom inventory query and export CSV
      - name: Export CSV inventory
        shell: bash
        run: |
          set -euo pipefail
          CODEQL="${{ steps.init-codeql.outputs.codeql-path }}"

          # Find the CodeQL DB produced by the action
          DB_DIR="$(find "$RUNNER_TEMP/codeql_databases" -type f -name codeql-database.yml -print -quit | xargs dirname || true)"
          if [ -z "${DB_DIR:-}" ]; then
            echo "Could not locate CodeQL Java database"; ls -R "$RUNNER_TEMP" || true; exit 1
          fi
          echo "Using DB at: $DB_DIR"

          # Build a resolver search path: official packs + our queries pack
          QLPACKS_DIR="$(dirname "$CODEQL")/../qlpacks"
          SEARCH_PATH="$QLPACKS_DIR:./queries"
          echo "Search path: $SEARCH_PATH"

          # Run the custom query
          "$CODEQL" query run queries/crypto-inventory.ql \
            --database "$DB_DIR" \
            --search-path "$SEARCH_PATH" \
            --additional-packs ./queries \
            --output results.bqrs

          # Decode to CSV
          "$CODEQL" bqrs decode results.bqrs --format=csv > inventory.csv

          # Optional: quick weak-crypto flags
          egrep -i 'MD5|SHA-1|SHA1withRSA|DES|3DES|RC4|AES/ECB|TLSv1(?!\.)|SHA1PRNG|RSA.*,Arg0,1[0-9]{3}' inventory.csv || true > legacy_flags.txt

      - name: Upload inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-inventory
          path: |
            inventory.csv
            legacy_flags.txt
